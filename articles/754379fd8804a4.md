---
title: "http.ListenAndServe ã£ã¦ä½•ã—ã¦ã„ã‚‹ã®ï¼Ÿ"
emoji: "ğŸ"
type: "tech"
topics: ["Go"]
published: false
---

# ã¯ã˜ã‚ã«

Go ã®å­¦ç¿’ã‚’å§‹ã‚ãŸæ™‚ã«ãƒ“ãƒƒã‚¯ãƒªã—ãŸã®ã¯ã€ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã‚‹ã“ã¨ã®ç°¡å˜ã•ã§ã—ãŸã€‚
ä¾‹ãˆã°ä»¥ä¸‹ã®æ‰‹é †ã§ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

```go:main.go
package main

import "net/http"

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte("Hello, World!"))
	})
	http.ListenAndServe(":8080", nil)
}
```

```ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ go run main.go
```

```åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ curl http://localhost:8080/
Hello, World!
```

ã‚ã¡ã‚ƒãã¡ã‚ƒç°¡å˜ãªåé¢ã€ http.ListenAndServer ã£ã¦ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã£ãŸã®ã§ã€€net/http ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã—ã¦ã¿ã¾ã—ãŸã€‚

# çµè«–

Server ã¯ Listener ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç²å¾—ã—ã¦ã€ Handler ã‚’å®Ÿè¡Œã—ã¦ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡Œãªã£ã¦ã„ã‚‹ã€‚
http.ListenAndServe ã¯ã“ã‚Œã‚’æ¥½ã«å®Ÿç¾ã—ã¦ãã‚Œã‚‹é–¢æ•°ã§ã‚ã‚‹ã€‚

ã“ã®çµè«–ã«è¾¿ã‚Šç€ããŸã‚ã«ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã„ãã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

### http.ListenAndServe

Server æ§‹é€ ä½“ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ handler ã‚’æ¸¡ã—ã¦æ§‹é€ ä½“ã‚’ç”Ÿæˆã—ã€ ListenAndServe ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ã ã‘ã§ã™ã€‚

```go:net/http/server.go
func ListenAndServe(addr string, handler Handler) error {
	server := &Server{Addr: addr, Handler: handler}
	return server.ListenAndServe()
}
```

å…ˆã»ã©ã®ä¾‹ã§ã¯ç¬¬äºŒå¼•æ•°ã§ã‚ã‚‹ handler ã«ã¯ nil ã‚’æ¸¡ã—ã¦ã„ã¾ã—ãŸãŒã€ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ã“ã†ã‚ã‚Šã€ nil ã®æ™‚ã«ã¯ http.DefaultServeMux ãŒä½¿ã‚ã‚Œã¾ã™ã€‚

```go:net/http/server.go
type Server struct {
	// ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯çœç•¥

	Handler Handler // handler to invoke, http.DefaultServeMux if nil
}
```

ã¡ãªã¿ã« DefaultServeMux ã® Mux ã¯ multiplexer ã®ã“ã¨ã§ã™ã€‚
å‚è€ƒ: https://wa3.i-3-i.info/word13228.html

DefaultServeMux ã¯ ServeMux ã®ç©ºã®æ§‹é€ ä½“ã®ã“ã¨ã§ã™ãŒã€ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ã“ã†ã‚ã‚Šã¾ã™ã€‚
å¤§é›‘æŠŠã«ç†è§£ã‚’ã™ã‚Œã°ã€ URL ã®ãƒãƒƒãƒãƒ³ã‚°ã‚’è¡Œã†ã‚‚ã®ã¨è€ƒãˆã¦è‰¯ã•ãã†ã§ã™ã€‚

```go:net/http/server.go
// ServeMux is an HTTP request multiplexer.
// It matches the URL of each incoming request against a list of registered
// patterns and calls the handler for the pattern that
// most closely matches the URL.
// çœç•¥
type ServeMux struct {
	mu       sync.RWMutex
	tree     routingNode
	index    routingIndex
	patterns []*pattern  // TODO(jba): remove if possible
	mux121   serveMux121 // used only when GODEBUG=httpmuxgo121=1
}
```

ãªãŠå†’é ­ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯ http.HandleFunc ã§ãƒ‘ã‚¹ã¨ handler ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç´ä»˜ã‘ã‚’è¡Œãªã£ã¦ã„ã¾ã™ãŒã€ä¸­ã‚’èª­ã‚€ã¨ DefaultServeMux ã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç™»éŒ²ã‚’è¡Œãªã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
DefaultServeMux ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå¤‰æ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ç¬¬äºŒå¼•æ•°ã§ nil ã‚’æ¸¡ã—ã¦ã„ãªã„ã®ã«ã‚³ãƒ¼ãƒ«ã—ã¦ã‚‚æ„å‘³ãŒãªã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚

```go:net/http/server.go
func HandleFunc(pattern string, handler func(ResponseWriter, *Request)) {
	if use121 {
		DefaultServeMux.mux121.handleFunc(pattern, handler)
	} else {
		DefaultServeMux.register(pattern, HandlerFunc(handler))
	}
}
```

### server.ListenAndServe

Listener ã‚’ç”Ÿæˆã—ã¦ã€ãã‚Œã‚’ Serve ãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚
http.ListenAndServe ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å—ã‘å–ã£ã¦ã„ã¦ã€ãã‚Œã¯ Server æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥ã£ã¦ã„ã¾ã—ãŸãŒã€ Listener ã®ç”Ÿæˆã®ãŸã‚ã ã£ãŸã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```go:net/http/server.go
func (srv *Server) ListenAndServe() error {
	if srv.shuttingDown() {
		return ErrServerClosed
	}
	addr := srv.Addr
	if addr == "" {
		addr = ":http"
	}
	ln, err := net.Listen("tcp", addr)
	if err != nil {
		return err
	}
	return srv.Serve(ln)
}
```

- ListenAndServe ã§ã¯å…ˆã»ã©å—ã‘å–ã£ãŸ address ã‚’ Listener ã«æ¸¡ã—ã¦ã„ã‚‹ã€‚
  - Listen ã¯ tcp ãŒãƒ™ã‚¿ã§æ¸¡ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯ä½•ãªã‚“ã ã‚ã†ã€‚
  - ãã—ã¦å…ˆã»ã© server ã® Serve ãŒ listener ã‚’é…ã£ã¦ã„ã‚‹æ„Ÿã˜

- Serve ã®ä¸­ã‚’è¦‹ã‚‹ã¨ã€ l.Accept ã‚’èª­ã‚“ã§ã„ã¦ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ serve ã—ã¦ã„ã‚‹æ„Ÿã˜

- conn.serve ã®ä¸­ã‚’èª­ã‚€ã¨ã€ãã“ã§ handler ã‚’èª­ã‚“ã§ã„ã‚‹
  - serverHandler.ServeHTTP ã§ DefaultServeMux ã‚’å…¥ã‚Œã¦ã‚ã‚‹