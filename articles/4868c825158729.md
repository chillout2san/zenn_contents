---
title: "Golangã§å­¦ã¶Cookie"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go"]
published: true
---

# åŸ·ç­†ã®ãã£ã‹ã‘

è¶£å‘³ã§Goã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§èªè¨¼ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Cookieã«ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚
`Cookie`æ§‹é€ ä½“ã‚’è¦—ãã¨è‰²ã€…ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã€è©³ã—ãèª¿ã¹ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚
æœ¬è¨˜äº‹ã§ã¯ã¾ãšCookieã¨ã¯ä½•ã‹ã‚’èª¿ã¹ã€æœ€çµ‚çš„ã«Goä¸Šã§ã©ã†æ‰±ãˆã°è‰¯ã„ã®ã‹ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚

# ãã‚‚ãã‚‚Cookieã¨ã¯ï¼Ÿ

MDNã«ã¯ã“ã†ã‚ã‚Šã¾ã™ã€‚

> HTTP Cookie (ã‚¦ã‚§ãƒ– Cookieã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ Cookie) ã¯ã€ã‚µãƒ¼ãƒãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚§ãƒ–ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«é€ä¿¡ã™ã‚‹å°ã•ãªãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«ä¿å­˜ã•ã‚Œã€ãã®å¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å…±ã«åŒã˜ã‚µãƒ¼ãƒãƒ¼ã¸è¿”é€ã•ã‚Œã¾ã™ã€‚

> ä¸€èˆ¬çš„ã«ã¯ã€ 2 ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚‹ã‹ã‚’çŸ¥ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

Goã§Cookieã‚’ã‚»ãƒƒãƒˆãƒ»èª­ã¿è¾¼ã‚€ç°¡å˜ãªå®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```go
func setCookie(w http.ResponseWriter, r *http.Request) {
    cookie := &http.Cookie{
        Name:    "token",
        // èªè¨¼ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã€‚jwtå…¥ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã¨æ€ã„ã¾ã™
        Value:   "example_token_value"
    }
    // ã‚µãƒ¼ãƒã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã«Cookieã‚’æ¸¡ã™å‡¦ç†
    http.SetCookie(w, cookie)
}

func readCookie(w http.ResponseWriter, r *http.Request) {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰Cookieã‚’å—ã‘å–ã‚‹å‡¦ç†
    token, err := r.Cookie("token")

    if token.Value == "example_token_value" {
        // èªè¨¼æˆåŠŸ
    }
}
```

Cookieã‚’ä½“é¨“ã™ã‚‹ãã‚‰ã„ãªã‚‰`Name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨`Value`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ååˆ†ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ãŒã€ã‚‚ã£ã¨è‰²ã€…ãªè¨­å®šé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚

# Cookieæ§‹é€ ä½“ã‚’è¦‹ã¦ã¿ã‚‹

Goã®`Cookie`æ§‹é€ ä½“ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã€‚

```go:net/http/cookie.go
// A Cookie represents an HTTP cookie as sent in the Set-Cookie header of an
// HTTP response or the Cookie header of an HTTP request.
//
// See https://tools.ietf.org/html/rfc6265 for details.
type Cookie struct {
	Name  string
	Value string

	Path       string    // optional
	Domain     string    // optional
	Expires    time.Time // optional
	RawExpires string    // for reading cookies only

	// MaxAge=0 means no 'Max-Age' attribute specified.
	// MaxAge<0 means delete cookie now, equivalently 'Max-Age: 0'
	// MaxAge>0 means Max-Age attribute present and given in seconds
	MaxAge   int
	Secure   bool
	HttpOnly bool
	SameSite SameSite
	Raw      string
	Unparsed []string // Raw text of unparsed attribute-value pairs
}
```

`Name`ã¨`Value`ã¯åˆ†ã‹ã‚‹ã€‚ã•ã£ãè¦‹ãŸé€šã‚Šã€‚ãã‚Œä»¥å¤–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½ã£ã¦ã„ãã€‚

### Pathå±æ€§

MDNã‹ã‚‰ã€‚

> Path å±æ€§ã¯ã€ Cookie ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸ URL ã®ä¸­ã«å«ã‚€å¿…è¦ãŒã‚ã‚‹ URL ã®ãƒ‘ã‚¹ã‚’ç¤ºã—ã¾ã™ã€‚ %x2F ("/") ã®æ–‡å­—ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼åŒºåˆ‡ã‚Šæ–‡å­—ã¨ã—ã¦è§£é‡ˆã•ã‚Œã€ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã«ã‚‚åŒæ§˜ã«ä¸€è‡´ã—ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

å‰è¿°ã®ã¨ãŠã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯å—ã‘å–ã£ãŸCookieã‚’ã‚µãƒ¼ãƒã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è‡ªå‹•é€ä¿¡ã™ã‚‹ã‚ã‘ã§ã™ãŒã€ãã®è‡ªå‹•é€ä¿¡ã™ã‚‹ãƒ‘ã‚¹ã®çµã‚Šè¾¼ã¿ãŒå¯èƒ½ã§ã™ã€‚

çœç•¥ã™ã‚‹ã¨ã€Cookieã‚’ç™ºè¡Œã—ãŸãƒ‘ã‚¹ãŒå…¥ã‚Šã¾ã™ã€‚
ä¾‹ãˆã°`https://example.com/login`ã¿ãŸã„ãªAPIã‚’å©ã„ã¦cookieãŒã‚»ãƒƒãƒˆã•ã‚ŒãŸã¨ã—ã¦ã€Pathå±æ€§ã‚’è¨­å®šã—ã¦ã„ãªã„ã¨ã€`Path=/login`ã«ãªã‚Šã¾ã™ã€‚

`Cookie`æ§‹é€ ä½“ã§ã¯è¨­å®šã¯optionalã«ãªã£ã¦ã„ã¾ã™ãŒã€å…ˆã»ã©ã®ä¾‹ã§è¨€ã†ã¨ã€`/login`ä»¥å¤–ã®APIã‚’ã‚³ãƒ¼ãƒ«ã—ãŸæ™‚ã«ã¯CookieãŒé€ã‚‰ã‚Œãªããªã‚‹ã®ã§ã€`/`ã‚’è¨­å®šã—ã¦ãŠãã®ãŒè‰¯ã•ãã†ã§ã™ã€‚

### Domainå±æ€§

MDNã‹ã‚‰ã€‚

> Domain å±æ€§ã¯ã€Cookie ã‚’å—ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ›ã‚¹ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€æ—¢å®šã§ Cookie ã‚’è¨­å®šã—ãŸã®ã¨åŒã˜ãƒ›ã‚¹ãƒˆã¨ãªã‚Šã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯é™¤å¤–ã•ã‚Œã¾ã™ã€‚ Domain ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯å¸¸ã«å«ã¾ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ Domain ã‚’æŒ‡å®šã™ã‚‹ã¨çœç•¥æ™‚ã‚ˆã‚Šã‚‚åˆ¶é™ãŒç·©å’Œã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å…±æœ‰ã™ã‚‹å ´åˆã¯æœ‰ç”¨ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

> ä¾‹ãˆã°ã€Domain=mozilla.org ã‚’è¨­å®šã™ã‚‹ã¨ã€developer.mozilla.org ã®ã‚ˆã†ãªã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚‚å«ã¾ã‚Œã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

è¨­å®šã‚’çœç•¥ã—ãŸæ–¹ãŒåˆ¶é™ãŒå³ã—ã„ã‚ã‘ãªã®ã§ã€ç‰¹æ®µäº‹æƒ…ãŒãªã‘ã‚Œã°(â‰’ã‚ˆãåˆ†ã‹ã‚‰ãªã‘ã‚Œã°)æŒ‡å®šã—ãªã„ã§è‰¯ã•ãã†ã§ã™ã€‚
`Cookie`æ§‹é€ ä½“ã«ã‚‚optionalã¨ã‚³ãƒ¡ãƒ³ãƒˆãŒã¤ã„ã¦ã„ã¾ã™ã€‚

### Expireså±æ€§

RFC6235ã‹ã‚‰ã€‚

> Expireså±æ€§ã¯ã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ€å¤§æœ‰åŠ¹æœŸé™ã‚’ç¤ºã—ã¾ã™ã€‚ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã‚‹æ—¥ä»˜ã¨æ™‚åˆ»ã§è¡¨ã•ã‚Œã¾ã™ã€‚

https://www.rfc-editor.org/rfc/rfc6265#section-4.1.2.1

Cookieã®æœŸé™ã‚’`Sat, 04 Feb 2023 08:40:45 GMT`ã®ã‚ˆã†ãªæ—¥ä»˜ãƒ»æ™‚åˆ»ã§è¡¨ç¾ã—ã¾ã™ã€‚
Goã§ã¯`Time`æ§‹é€ ä½“ã§è¡¨ç¾ã§ãã‚‹ã®ã§ã€ã‚ã¾ã‚Šæ›¸å¼ã¯æ„è­˜ã—ãªãã¦æ¸ˆã¿ã¾ã™ã­ã€‚

ä½™è«‡ã§ã™ãŒRFC6235å†…ã«æ—¥ä»˜ã®æ›¸å¼ã«ã¤ã„ã¦è¨˜è¿°ãŒã‚ã‚Šã¾ã™ãŒã€æ­£ç›´å…¨ç„¶èª­ã‚ãªã‹ã£ãŸã®ã§ã€å®Ÿéš›ã®Cookieã‹ã‚‰Expireså±æ€§ã®å€¤ã‚’å¼•ã£å¼µã£ã¦ãã¾ã—ãŸã€‚

https://www.rfc-editor.org/rfc/rfc6265#section-5.1.1

### Max-Ageå±æ€§

RFC6235ã‹ã‚‰ã€‚

> Max-Ageå±æ€§ã¯ã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ€å¤§æœ‰åŠ¹æœŸé™ã‚’ç¤ºã—ã¾ã™ã€‚
> ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã¾ã§ã®ç§’æ•°ã§è¡¨ã•ã‚Œã¾ã™ã€‚ 
> ã‚‚ã—ã‚¯ãƒƒã‚­ãƒ¼ãŒMax-Ageã¨Expireså±æ€§ã®ä¸¡æ–¹ã‚’æŒã¤å ´åˆã€Max-Ageå±æ€§ãŒå„ªå…ˆã•ã‚Œã€ã‚¯ãƒƒã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ã‚’ç®¡ç†ã—ã¾ã™ã€‚
> ã‚¯ãƒƒã‚­ãƒ¼ãŒMax-Ageã¨Expiresã®ã©ã¡ã‚‰ã‚‚æŒãŸãªã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å±æ€§ãŒãªã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã€ã¾ã§ãã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä¿æŒã—ã¾ã™ã€‚

https://www.rfc-editor.org/rfc/rfc6265#section-5.2.1:~:text=4.1.2.2.%20%20The%20Max%2DAge%20Attribute

æœ‰åŠ¹æœŸé™ã¾ã§ã®ç§’æ•°ãŒMax-Ageå±æ€§ãªã®ã§ã€`Cookie`æ§‹é€ ä½“ã§intå‹ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚
ã¾ãŸå„ªå…ˆé †ä½ã‚‚Expireså±æ€§ã‚ˆã‚Šé«˜ãã€Max-Ageå±æ€§ã‚‚Expireså±æ€§ã‚‚ä¸¡æ–¹ãªã‘ã‚Œã°ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¾ã§ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚(ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰é–‰ã˜ãŸã‚‰çµ‚ã‚ã‚Š)

Max-Ageå±æ€§ã¨Expireså±æ€§ã®ã©ã¡ã‚‰ã‚’è¨­å®šã™ã‚Œã°è‰¯ã„ã®ã‹å½“ç„¶ã®ç–‘å•ãŒç”Ÿã˜ã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜äº‹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚
IEãŒMax-Ageå±æ€§ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚‰ãšã€Expireså±æ€§ã®è¨­å®šãŒå¿…é ˆã¨ã„ã†äº‹æƒ…ãŒã‚ã£ãŸã‚ˆã†ã§ã™ã€‚

https://teratail.com/questions/43007

RFCã«ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ãªæ³¨æ„æ›¸ããŒã‚ã‚Šã¾ã—ãŸã€‚

>æ³¨æ„ï¼šã„ãã¤ã‹ã®æ—¢å­˜ã®åˆ©ç”¨è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ï¼ŒMax-Ageå±æ€§ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ Max-Ageå±æ€§ã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„åˆ©ç”¨è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã“ã®å±æ€§ã‚’ç„¡è¦–ã—ã¾ã™ã€‚

IEå¯¾å¿œã®å¿…è¦ãŒã‚‚ã†çµ‚ã‚ã£ãŸç¾åœ¨ã¨ãªã£ã¦ã¯ã€Max-Ageã‚’ä½¿ã£ã¦ã„ãã¹ããªã‚“ã§ã—ã‚‡ã†ã‹ã€‚
Max-Ageå±æ€§ã«å€¤ã‚’è¨­å®šã™ã‚‹ã‚ˆã†ãªç°¡å˜ãªã‚µãƒ¼ãƒã‚’ç«‹ã¦ã€Postmanã§ã‚³ãƒ¼ãƒ«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã™ã‚‹ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã¯Max-Ageå±æ€§ãŒã‚ã‚‹ã«ã‚‚é–¢ã‚ã‚‰ãšã€ä½•æ•…ã‹Expireså±æ€§ã«ç½®ãæ›ã‚ã£ã¦ã„ã¾ã—ãŸã€‚
ã¾ãŸChromeã®devãƒ„ãƒ¼ãƒ«ã§Cookieã®æ¬„ã‚’è¦‹ã‚‹ã¨ã€Expireså±æ€§ã¯ã‚ã‚Šã¾ã—ãŸãŒã€Max-Ageå±æ€§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã†ãƒ¼ã‚“ã€RFCã‚’èª­ã‚€é™ã‚Šã¯Max-Ageå±æ€§å„ªå…ˆã¨ã‚ã‚Šã¾ã™ãŒã€å®Ÿç”¨ä¸Šã¯Expireså±æ€§ã®æ–¹ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚“ã§ã—ã‚‡ã†ã‹ã€‚

### Secureå±æ€§

MDNã‹ã‚‰ã€‚

> Secure å±æ€§ãŒã¤ã„ãŸ Cookie ã¯ HTTPS ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä¸Šã®æš—å·åŒ–ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®ã¿ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã€å®‰å…¨ã§ãªã„ HTTP ã§ã¯æ±ºã—ã¦é€ä¿¡ã•ã‚Œãªã„ãŸã‚ã€

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

Goã§ã¯boolå‹ã«ãªã£ã¦ã„ã¦ã€trueã«ã™ã‚Œã°httpsã§ãªã„å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚µãƒ¼ãƒã«CookieãŒé€ã‚‰ã‚Œãªããªã‚Šã¾ã™ã€‚
æœ¬ç•ªç’°å¢ƒãªã‚Šãƒ†ã‚¹ãƒˆç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã¯trueã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯falseã«ã™ã‚‹ã‚ˆã†è¨­å®šã™ã‚‹æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚

### HttpOnlyå±æ€§

MDNã‹ã‚‰ã€‚

> HttpOnly å±æ€§ã‚’æŒã¤ Cookie ã¯ã€ JavaScript ã® Document.cookie API ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ã ã‘ã§ã™ã€‚ä¾‹ãˆã°ã€ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æŒç¶šã•ã›ã‚‹ Cookie ã¯ JavaScript ãŒåˆ©ç”¨ã™ã‚‹å¿…è¦ã¯ãªã„ã®ã§ã€ HttpOnly å±æ€§ã‚’ã¤ã‘ã‚‹ã¹ãã§ã™ã€‚ã“ã®äºˆé˜²ç­–ã¯ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚° (XSS) æ”»æ’ƒã‚’ç·©å’Œã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

åŒã˜ãGoã§ã¯boolå‹ã«ãªã£ã¦ã„ã¾ã™ã€‚å¼•ç”¨ã®ã¨ãŠã‚Šã€trueã«ã—ã¦ãŠã„ã¦è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

### SameSiteå±æ€§

MDNã‹ã‚‰ã€‚

> SameSite å±æ€§ã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒãƒ¼ãŒã‚µã‚¤ãƒˆé–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ã“ã“ã§ã‚µã‚¤ãƒˆã¯ç™»éŒ²å¯èƒ½ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¾ã™) ã¨ä¸€ç·’ã« Cookie ã‚’é€ã‚‹ã¹ãã§ã¯ãªã„ã“ã¨ã‚’è¦æ±‚ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> å–ã‚‹ã“ã¨ãŒã§ãã‚‹å€¤ã¯ Strict, Lax, None ã® 3 ã¤ã§ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

`cookie.go`ã‹ã‚‰ã€‚

```go:net/http/cookie.go
// SameSite allows a server to define a cookie attribute making it impossible for
// the browser to send this cookie along with cross-site requests. The main
// goal is to mitigate the risk of cross-origin information leakage, and provide
// some protection against cross-site request forgery attacks.
//
// See https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00 for details.
type SameSite int
```

ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç›´è¨³ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

> SameSiteã¯ã€ã‚µãƒ¼ãƒãƒ¼ãŒã‚¯ãƒƒã‚­ãƒ¼ã®å±æ€§ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã¨ã‚‚ã«ã“ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚’ä¸å¯èƒ½ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¸»ãªç›®çš„ã¯ã€ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³æƒ…å ±æ¼ãˆã„ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã—ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªæ”»æ’ƒã‹ã‚‰ã‚ã‚‹ç¨‹åº¦ä¿è­·ã™ã‚‹ã“ã¨ã§ã™ã€‚

å‰è¿°ã®ã¨ãŠã‚Šãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«Cookieã‚’ã‚µãƒ¼ãƒã«è‡ªå‹•ã§é€ä¿¡ã—ã¾ã™ãŒã€ãã®ã‚µãƒ¼ãƒã®ç¯„å›²ã‚’åˆ¶é™ã—ã¾ã™ã€‚

`Strict`ã¯åå‰ã®ã¨ãŠã‚Šå³ã—ã„åˆ¶é™ã§ã€Cookieã‚’ä»˜ä¸ã—ãŸã‚µãƒ¼ãƒã«ã®ã¿é€ä¿¡ã—ã¾ã™ã€‚
ä¾‹ãˆã°ã‚µã‚¤ãƒˆAã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚µã‚¤ãƒˆAã®Cookieã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãŒä¿æŒã—ã¦ã„ãŸã¨ã—ã¾ã™ã€‚
ãã—ã¦ã‚µã‚¤ãƒˆBã«æ²è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚µã‚¤ãƒˆAã®ãƒªãƒ³ã‚¯ã‚’è¸ã‚“ã§ã‚µã‚¤ãƒˆAã‚’è¨ªå•ã—ãŸå ´åˆã€Cookieã«ã¯ã‚µã‚¤ãƒˆAã®ã‚‚ã®ãŒã‚ã‚‹ã‚ã‘ã§ã™ãŒã€`Strict`ã®å ´åˆã¯é€ä¿¡ã—ãªã„ã®ã§ã€æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

`Lax`ã¯`Strict`åŒæ§˜ã€Cookieã‚’ä»˜ä¸ã—ãŸã‚µãƒ¼ãƒã«ã®ã¿é€ä¿¡ã—ã¾ã™ãŒã€ä»–ã®ã‚µã‚¤ãƒˆã‹ã‚‰é·ç§»ã—ã¦ã‚‚cookieã‚’é€ä¿¡ã—ã¾ã™ã€‚
å…ˆã»ã©ã®ä¾‹ã§è¨€ãˆã°ã€ã‚µã‚¤ãƒˆBã‹ã‚‰ã‚µã‚¤ãƒˆAã‚’è¨ªå•ã—ãŸéš›ã€ã‚µã‚¤ãƒˆAã®Cookieã‚’é€ä¿¡ã™ã‚‹ã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ã¾ã¾ã§ã™ã€‚

ã‚‚ã†å°‘ã—è©³ã—ãè¨€ã†ã¨ã€ã‚µã‚¤ãƒˆBã‹ã‚‰ã‚µã‚¤ãƒˆAã«GETãƒ¡ã‚½ãƒƒãƒ‰ã§é·ç§»ã—ãŸå ´åˆã¯å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

`None`ã¯å…ˆã»ã©ã®ä¾‹ã§è¨€ãˆã°ã€ã‚µã‚¤ãƒˆBè¨ªå•æ™‚ã«ã‚µã‚¤ãƒˆAã®Cookieã‚’é€ä¿¡ã—ã¾ã™ã€‚
ã“ã®å ´åˆã€Secureå±æ€§ãŒtrueã§ã‚ã‚‹ã€ã¤ã¾ã‚Šhttpsé€šä¿¡ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

çµå±€ä½•ãŒå—ã‘å–ã‚Œã‚‹ã®ã‹æ··ä¹±ã—ã¾ã™ã­ã€‚
ä»¥ä¸‹Qiitaè¨˜äº‹ã§ã®å®Ÿé¨“ãŒéå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

https://qiita.com/akaaariiiiin/items/b3078b53621c79188f6e

ç‰¹ã«å¿…è¦ãŒãªã„é™ã‚Šã€`Strict`ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

### RawExpiresãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€Rawãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€Unparsedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

:::message
èª¿ã¹ã¦ã‚‚ã‚ã¾ã‚Šæƒ…å ±ãŒãªãèª¿æŸ»ä¸­ã§ã™ã€‚(ã‚‚ã†ã¡ã‚‡ã£ã¨ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¿…è¦ãã†)
MDNã«ã‚‚RFCã«ã‚‚è¨˜è¿°ãªã•ãã†ã ã£ãŸã®ã§ã€Cookieã®å±æ€§ã¨ã„ã†ã‚ˆã‚ŠGoç‹¬è‡ªã®ä»•çµ„ã¿ãªæ°—ãŒã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸæœ¬è¨˜äº‹æœ«å°¾ã§`SetCookie`é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã—ã¦ã„ã¾ã™ãŒã€ãã®ä¸­ã§ã¯ã„ãšã‚Œã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚å‡ºã¦ã“ãªã‹ã£ãŸã®ã§ã€Cookieã‚’èª­ã¿è¾¼ã‚€æ™‚ã«ä½¿ã‚ã‚Œãã†ã¨è¸ã‚“ã§ã¾ã™ã€‚
:::

# Cookieæ§‹é€ ä½“ã‚’ã©ã†æ‰±ã†ã‹

ãƒã‚¤ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚

1. Pathå±æ€§ã¯`/`ã‚’æŒ‡å®šã™ã‚‹ã€‚
2. Domainå±æ€§ã¯è¨­å®šã—ãªã„ã€‚
3. Expireså±æ€§ã«æœ‰åŠ¹æœŸé–“ã‚’è¨­å®šã™ã‚‹ã€‚
4. Max-Ageå±æ€§ã¯è¨­å®šã—ãªã„ã€‚(ç¢ºä¿¡ãŒãªã„ãŒä»Šå›ã¯ãã†ã—ã¦ã¿ã‚‹)
5. Secureå±æ€§ã¯æœ¬ç•ªç’°å¢ƒã¯å½“ç„¶ã¨ã—ã¦ãƒ†ã‚¹ãƒˆç’°å¢ƒç­‰ã§ã¯trueã€é–‹ç™ºç’°å¢ƒã¯falseã«ç’°å¢ƒå¤‰æ•°ç­‰ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚è‡ªå·±è¨¼æ˜æ›¸ç­‰ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚httpsé€šä¿¡ã§ãã‚‹ãªã‚‰ãšã£ã¨trueã§ã‚‚è‰¯ã„ã‹ã‚‚ã€‚
6. HttpOnlyå±æ€§ã¯trueã€‚
7. SameSiteå±æ€§ã¯Strictã€‚

```go
func setCookie(w http.ResponseWriter, r *http.Request) {
    cookie := &Cookie {
        Name: "token",
        Value: "example_token",
        Path: "/",
        Expires: time.Now().Add(60 * time.Minute), // 1æ™‚é–“è¨­å®šã™ã‚‹ä¾‹ã€‚å¯èƒ½ãªé™ã‚ŠçŸ­ãã™ã‚‹
        Secure: os.Getenv("COOKIE_SECURE"), // æœ¬ç•ªã¨ãƒ­ãƒ¼ã‚«ãƒ«ã§åˆ‡ã‚Šæ›¿ãˆã§ãã‚‹ã‚ˆã†ã«
        HttpOnly: true,
        SameSite: http.SameSiteStrictMode,
    }
    // ã‚µãƒ¼ãƒã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã«Cookieã‚’æ¸¡ã™å‡¦ç†
    http.SetCookie(w, cookie)
}
```

# ãŠã¾ã‘:SetCookieãƒ¡ã‚½ãƒƒãƒ‰ã®ã‹ã‚‹ãƒ¼ã„ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã‚„ã£ã¦ã¿ã‚‹

å…ˆã»ã©`Cookie`æ§‹é€ ä½“ã«`Domain`å±æ€§ã‚’è¨­å®šã—ã¦ã„ã¾ã›ã‚“ãŒã€ã©ã®ã‚ˆã†ã«å‡¦ç†ã—ã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã£ãŸã®ã§ã€`http.SetCookie`é–¢æ•°ã‚’è»½ãèª­ã‚“ã§ã¿ã¾ã—ãŸã€‚
æ·±ã„å®Ÿè£…ã¾ã§ã¯è¿½ã‚ãšã€ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚’è¿½ã„ã‹ã‘ã‚‹ã«ç•™ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`SetCookie`é–¢æ•°ã¯`Cookie`æ§‹é€ ä½“ã®`String`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã€Cookieã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚

```go:net/http/cookie.go
// SetCookie adds a Set-Cookie header to the provided ResponseWriter's headers.
// The provided cookie must have a valid Name. Invalid cookies may be
// silently dropped.
func SetCookie(w ResponseWriter, cookie *Cookie) {
	if v := cookie.String(); v != "" {
		w.Header().Add("Set-Cookie", v)
	}
}
```

ã§ã¯ã©ã®ã‚ˆã†ã«Cookieã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã‹`String`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
å®Ÿè£…ãŒé•·ã„ã®ã§å°‘ã—ãšã¤æŠœç²‹ã—ãªãŒã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚
ã¾ãšå…¨ä½“åƒã‚’ä¿¯ç°ã—ã¾ã—ã‚‡ã†ã€‚

```go:net/http/cookie.go
// String returns the serialization of the cookie for use in a Cookie
// header (if only Name and Value are set) or a Set-Cookie response
// header (if other fields are set).
// If c is nil or c.Name is invalid, the empty string is returned.
func (c *Cookie) String() string {
    if c == nil || !isCookieNameValid(c.Name) { // Cookieã®åå‰ã«ä¸é©ãªæ–‡å­—ãŒå…¥ã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        return ""
    }
    // extraCookieLength derived from typical length of cookie attributes
    // see RFC 6265 Sec 4.1.
    const extraCookieLength = 110
    var b strings.Builder // Cookieã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ç®±ã‚’ä½œæˆ
    b.Grow(len(c.Name) + len(c.Value) + len(c.Domain) + len(c.Path) + extraCookieLength) // ç®±ã®ã‚­ãƒ£ãƒ‘ã‚’è¨­å®šã™ã‚‹
    // ä»¥ä¸‹ã®3è¡Œã§Cookieã®æ ¸ã«ãªã‚‹`åå‰=å€¤`ã‚’è¨­å®šã™ã‚‹ã€‚ã•ã£ãã¾ã§ã®ä¾‹ã ã¨ã€`token=example_token`ã«ãªã‚‹ã€‚
    b.WriteString(c.Name)
    b.WriteRune('=')
    b.WriteString(sanitizeCookieValue(c.Value))

    // çœç•¥

    return b.String() // Cookieã®æ–‡å­—åˆ—ã‚’è¿”å´
}
```

èª­ã¿é€²ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
æ¬¡ã¯Pathå±æ€§ã¨Domainå±æ€§ã®è¨­å®šã§ã™ã€‚

`A leading dot`ã£ã¦ã©ã†ã„ã†ã‚±ãƒ¼ã‚¹ã§ã‚ã‚‹ã®ã‹èª¿ã¹ãŸã¨ã“ã‚ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæœ‰åŠ¹ã¨ã„ã†æ„å‘³ã¿ãŸã„ã§ã™ã€‚
ãŸã å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§å•é¡Œã¨ãªã£ãŸã‚ˆã†ã§ã€ä»Šã¯æ°—ã«ã—ãªãã¦è‰¯ã„ã‚ˆã†ã§ã™ã€‚

https://stackoverflow.com/questions/9618217/what-does-the-dot-prefix-in-the-cookie-domain-mean

```go
func (c *Cookie) String() string {
    // çœç•¥

    // Pathãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Œã°æ›¸ãè¾¼ã‚€
    if len(c.Path) > 0 {
        b.WriteString("; Path=")
        b.WriteString(sanitizeCookiePath(c.Path))
    }
    // Domainãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Œã°æ›¸ãè¾¼ã‚€
    if len(c.Domain) > 0 {
        if validCookieDomain(c.Domain) {
            // A c.Domain containing illegal characters is not
            // sanitized but simply dropped which turns the cookie
            // into a host-only cookie. A leading dot is okay
            // but won't be sent.
            d := c.Domain
            // å…ˆé ­ã®ãƒ‰ãƒƒãƒˆã‚’èª­ã¿é£›ã°ã™
            if d[0] == '.' {
                d = d[1:]
            }
            b.WriteString("; Domain=")
            b.WriteString(d)
        } else {
            log.Printf("net/http: invalid Cookie.Domain %q; dropping domain attribute", c.Domain)
        }
    }

    // çœç•¥
}
```

èª­ã¿é€²ã‚ã¦ã„ãã¾ã™ã€‚
`TimeFormat`ã¯å®šæ•°ã§ä¸­èº«ãŒ`Mon, 02 Jan 2006 15:04:05 GMT`ã¨ã„ã†æ—¥ä»˜ã®æ–‡å­—åˆ—ã§ã—ãŸã€‚
çµå±€åˆ†ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã™ãŒã€`validCookieExpires`ã¯ä¸­ã§å¼•æ•°ã®`c.Expires`ã®`Year`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
`Expires`ãŒåˆæœŸå€¤ã®`nil`ã ã£ãŸæ™‚ã«ã¬ã‚‹ã½ãªã‚Šãã†ã ã£ãŸã‚“ã§ã™ãŒã€ã©ã“ã§å›é¿ã—ã¦ã‚‹ã‚“ã ã‚ã†...ã€‚

```go
func (c *Cookie) String() string {
    // çœç•¥

    var buf [len(TimeFormat)]byte
    // Expiresãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒé©æ­£ã§ã‚ã‚Œã°æ›¸ãè¾¼ã‚€(æ¡ä»¶å¼ãŒã‚ˆãåˆ†ã‹ã‚‰ãªã‹ã£ãŸ)
    if validCookieExpires(c.Expires) {
        b.WriteString("; Expires=")
        b.Write(c.Expires.UTC().AppendFormat(buf[:0], TimeFormat))
    }
    // MaxAgeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°æ›¸ãè¾¼ã‚€
    if c.MaxAge > 0 {
        b.WriteString("; Max-Age=")
        b.Write(strconv.AppendInt(buf[:0], int64(c.MaxAge), 10))
    } else if c.MaxAge < 0 {
        b.WriteString("; Max-Age=0")
    }
    // HttpOnlyãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒtrueãªã‚‰æ›¸ãè¾¼ã‚€
    if c.HttpOnly {
        b.WriteString("; HttpOnly")
    }
    // Secureãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒtrueãªã‚‰æ›¸ãè¾¼ã‚€
    if c.Secure {
        b.WriteString("; Secure")
    }

    // çœç•¥
}
```

ã•ã¦æœ€å¾Œã§ã™ã€‚SameSiteå±æ€§ã®å‡¦ç†ã‚’ã—ã¦çµ‚ã‚ã‚Šã§ã™ã€‚

```go
func (c *Cookie) String() string {
    // çœç•¥

    switch c.SameSite {
	case SameSiteDefaultMode:
		// Skip, default mode is obtained by not emitting the attribute.
	case SameSiteNoneMode:
		b.WriteString("; SameSite=None")
	case SameSiteLaxMode:
		b.WriteString("; SameSite=Lax")
	case SameSiteStrictMode:
		b.WriteString("; SameSite=Strict")
	}
	return b.String()
}
```

### ãŠã‚ã‚Šã«

Cookieã‚ˆãåˆ†ã‹ã‚‰ã‚“ãªã¨æ€ã£ã¦èª¿ã¹ã¦ã¿ã¾ã—ãŸãŒã€ã‚¹ãƒƒã‚­ãƒªã—ãŸé¢ã‚‚ã‚ã‚Œã°ã€è¬ãŒæ·±ã¾ã£ã¦ã—ã¾ã£ãŸã¨ã“ã‚ã‚‚ã‚ã‚Šã¾ã—ãŸ...ã€‚
ã”æ„è¦‹ã‚ã‚Œã°æ˜¯éã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚